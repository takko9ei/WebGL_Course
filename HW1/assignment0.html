<html>
  <head>
    <title>Minimal WebGL Example</title>
    <!-- NOTICE: I manually implemented the skeleton and style. This is modified from the original given skeleton file. -->
    <style>
      body {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        background: #333;
      }
      canvas {
        border: 1px solid white;
      }
    </style>
  </head>
  <body>
    <canvas id="glCanvas" style="width: 400px; height: 400px" />
    <!-- type="notjs" makes it not get identified as javascript. -->
    <script id="vertex-shader" type="notjs">
      #version 300 es
      in vec4 pos;
      in vec3 color;
      out vec2 coord;
      out vec3 vColor;
      void main() {
        vColor = color;
        coord = pos.xy*0.5+0.5;
        gl_Position = pos;
      }
    </script>
    <script id="fragment-shader" type="notjs">
      #version 300 es
      precision mediump float;
      in vec2 coord;
      in vec3 vColor;
      out vec4 color_out;
      void main() {
        color_out = vec4(vColor, 1.0);
      }
    </script>
    <script>
      //#region variables
      const vertices = [-1, -1, 1, -1, -1, 1, 1, 1];
      const verticeswithColor = [
        //position       //color
        -1, -1, 1, 0, 0, 1, -1, 0, 1, 0, -1, 1, 0, 0, 1, 1, 1, 1, 1, 0,
      ];
      const strideCount = 5; //position + color
      const stride = strideCount * Float32Array.BYTES_PER_ELEMENT; //float 32 refer to below
      //#endregion

      //#region initialization
      const canvas = document.getElementById("glCanvas");
      const gl = canvas.getContext("webgl2");
      if (!gl) throw new Error("WebGL unsupported!");
      //#endregion

      //#region shader setup
      const vsSource = document.getElementById("vertex-shader").text.trim();
      const fsSource = document.getElementById("fragment-shader").text.trim();
      const shaderProgram = initShaderProgram(gl, vsSource, fsSource);
      gl.useProgram(shaderProgram);
      //#endregion

      //#region bind
      let vbo = gl.createBuffer();
      let vao = gl.createVertexArray();
      gl.bindVertexArray(vao);
      gl.bindBuffer(gl.ARRAY_BUFFER, vbo);
      gl.bufferData(
        gl.ARRAY_BUFFER,
        new Float32Array(verticeswithColor),
        gl.STATIC_DRAW
      );
      let vertexPosAttrib = gl.getAttribLocation(shaderProgram, "pos"); //返回“pos”入口的位置
      gl.enableVertexAttribArray(vertexPosAttrib); //“启用入口”
      gl.vertexAttribPointer(vertexPosAttrib, 2, gl.FLOAT, false, stride, 0); //index size type normalized stride offset
      let vertexColAttrib = gl.getAttribLocation(shaderProgram, "color");
      gl.enableVertexAttribArray(vertexColAttrib);
      gl.vertexAttribPointer(
        vertexColAttrib,
        3,
        gl.FLOAT,
        false,
        stride,
        2 * Float32Array.BYTES_PER_ELEMENT
      );
      gl.bindVertexArray(null);
      gl.bindBuffer(gl.ARRAY_BUFFER, null);
      //#endregion

      //#region draw
      gl.bindVertexArray(vao);
      gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);
      //#endregion

      //#region shader helper functions
      function initShaderProgram(gl, vsSource, fsSource) {
        const vertexShader = loadShader(gl, gl.VERTEX_SHADER, vsSource);
        const fragmentShader = loadShader(gl, gl.FRAGMENT_SHADER, fsSource);
        if (!vertexShader || !fragmentShader) return null;
        const shaderProgram = gl.createProgram(); //distinguish with createshader
        gl.attachShader(shaderProgram, vertexShader);
        gl.attachShader(shaderProgram, fragmentShader);
        //two colomns above can be reversed
        gl.linkProgram(shaderProgram);
        if (!gl.getProgramParameter(shaderProgram, gl.LINK_STATUS)) {
          alert(
            "Unable to initialize the shader program: " +
              gl.getProgramInfoLog(shaderProgram)
          );
          return null;
        }
        return shaderProgram;
      }
      function loadShader(gl, type, source) {
        const shader = gl.createShader(type);
        gl.shaderSource(shader, source);
        console.log("Compiling shader:\n" + source);

        gl.compileShader(shader);
        //if compile fail
        if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
          console.error(
            "An error occurred compiling the shaders: " +
              gl.getShaderInfoLog(shader)
          );
          alert(
            "An error occurred compiling the shaders. Check console for details."
          );
          gl.deleteShader(shader);
          return null;
        }
        return shader;
      }
      //#endregion
    </script>
  </body>
</html>
